{
  "hash": "a9e020dc9bfc65d66ae658357df0ddc9",
  "result": {
    "markdown": "---\ntitle: \"CRD cookbook\"\ndate: '2025-11-02'\ncategories: [R]\nexecute:\n  message: false\n  warning: false\n  echo : true\n---\n\n\n# CRD version update in 2025\n\n| **#TL;DR:**\n| CRD ปี 2025 การรายงานควรที่จะแสดง “ค่าประมาณ + 95% CI” และขนาดเอฟเฟกต์ (η²/ω²) มากกว่าดูจากค่า p-value อย่างเดียว นะ\n\n## เกริ่น\n\nตั้งใจ ทำ การวิเคาะห์ข้อมูลการทดลองที่ออกแบบ CRD แบบที่คิดว่าสมบูรณ์ที่สุด รวบรวมมากจากทุกที่ โดยพยายามจะอัพเดท การวิเคราะห์ที่ทันสมัยให้มากที่สุด ในปี 2025\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# packages\npacman::p_load(\n  tidyverse, # data import and handling\n  conflicted, # handling function conflicts\n  emmeans,\n  multcomp,\n  multcompView, # adjusted mean comparisons\n  ggplot2,\n  effectsize, # effect size calculation\n  desplot, # for plotting experimental designs\n  rstatix,\n  ggdist,\n  performance,\n  see\n) # plots\n```\n\n::: {.cell-output .cell-output-stdout}\n```\npackage 'rstatix' successfully unpacked and MD5 sums checked\n\nThe downloaded binary packages are in\n\tC:\\Users\\sithj\\AppData\\Local\\Temp\\RtmpMnOMHd\\downloaded_packages\n```\n:::\n\n```{.r .cell-code}\n# conflicts between functions with the same name\nconflict_prefer(\"filter\", \"dplyr\")\nconflict_prefer(\"select\", \"dplyr\")\n```\n:::\n\n\n## Data\n\nข้อมูลที่มาทำได้เป็นงานวิจัยทดสอบผลผลิตเมลอน ตีพิมพ์ Mead et al. (1993, p.52) โดยการทดลองมีพันธุ์เมลอน 4 พันธุ์ แต่ละพันธุ์ได้รับการทดสอบในแปลงทดลองจำนวน 6 แปลง ออกแบบการทดสอบแบบ สุ่มสมบูรณ์ (CRD) จาก “Example 4.3” หนังสือ “Quantitative Methods in Biosciences (3402-420)” by Prof. Dr. Hans-Peter Piepho\n\n### Import and wrangle data\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndataURL <- \"https://raw.githubusercontent.com/SchmidtPaul/DSFAIR/master/data/Mead1993.csv\"\ndat <- read_csv(dataURL)\ndat %>% head()\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|variety | yield| row| col|\n|:-------|-----:|---:|---:|\n|v1      | 25.12|   4|   2|\n|v1      | 17.25|   1|   6|\n|v1      | 26.42|   4|   1|\n|v1      | 16.08|   1|   4|\n|v1      | 22.15|   1|   2|\n|v1      | 15.92|   2|   4|\n\n</div>\n:::\n:::\n\n\nแล้วเราจะยังต้องทำให้ตัวแปรต้นของเราเป็น `factor` เสียก่อนจึงจะถูกต้อง\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat <- dat %>% mutate(across(variety, as.factor))\n```\n:::\n\n\nมาดู ข้อมูลผลผลิตกันก่อนว่าเป็นอย่างไรในเมลอนแต่ละพันธุ์\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = dat, aes(y = yield, x = variety)) +\n  geom_point() + # scatter plot\n  ylim(0, NA) + # force y-axis to start at 0\n  theme_classic() # clearer plot format\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\nจากตรงนี้ก็พอจะเห็นอะไรบ้างว่า มีพันธุ์บางพันธุ์นั้น มีผลผลิตต่างกัน ต่อไป มาวิเคราะห์ ANOVA กัน\n\n## Modern ANOVA = `car::Anova(type = 3)`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit <- lm(yield ~ variety, data = dat)\ncar::Anova(fit, type = 3)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|            |    Sum Sq| Df|  F value| Pr(>F)|\n|:-----------|---------:|--:|--------:|------:|\n|(Intercept) | 2519.0406|  1| 137.0335|  0e+00|\n|variety     | 1291.4771|  3|  23.4184|  9e-07|\n|Residuals   |  367.6531| 20|       NA|     NA|\n\n</div>\n:::\n:::\n\n\nถ้าเป็น code แบบ classic ก็ใช้ `aov(yield ~ variety, data = dat)` ซึ่ง ถ้าเป็น ปัจจุบันตอนนี้ เราจะนิยมและปลอดภัยสุด หรือ ANOVA type จาก [Data Science for Agriculture in R](https://schmidtpaul.github.io/dsfair_quarto/ch/summaryarticles/anovatypes.html)\n\n> In most cases it’s probably best to conduct a `Type III` ANOVA, e.g. via `car::Anova(model, type = \"III\")`.\n\n## classic ANOVA\n\nแบบ ANOVA จาก R base ก็ใช้ได้เช่นกัน นะ\n\n\n::: {.cell}\n\n```{.r .cell-code}\naov.model <- aov(yield ~ variety, data = dat)\nsummary(aov.model)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n            Df Sum Sq Mean Sq F value   Pr(>F)    \nvariety      3 1291.5   430.5   23.42 9.44e-07 ***\nResiduals   20  367.7    18.4                     \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\nถ้า ไม่ sig เราก็ จะรายงาน เท่านี้ แต่ถ้าไม่ ส่วนใหญ่ เราก็จะไปทดสอบต่อ อย่างที่เรา เรียกกัน postpoc\n\n### ตรวจ Asusumption\n\nใช้ `performance` library หรือ `easystat` library เพื่อ check สมมุติฐาน และคุณภาพของข้อมูล ที่นำไปวิเคราะห์ ANOVA\n\n1.  Homogeneity check\n\n\n::: {.cell}\n\n```{.r .cell-code}\nperformance::check_homogeneity(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nOK: There is not clear evidence for different variances across groups (Bartlett Test, p = 0.314).\n```\n:::\n\n```{.r .cell-code}\nperformance::check_homogeneity(fit) %>% plot()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n2.  heteroscedasticit check\n\n\n::: {.cell}\n\n```{.r .cell-code}\nperformance::check_heteroscedasticity(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nOK: Error variance appears to be homoscedastic (p = 0.233).\n```\n:::\n\n```{.r .cell-code}\nperformance::check_heteroscedasticity(fit) %>% plot()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nบอกว่าต้องเชคอันนี้ก่อน เพราะว่ามันจะมีผลต่อ การวิเคราะห์ ANOVA เพราะว่า ถ้าไม่ ก็ ควรใช้ Welch ANOVA แทน\n\n3.  Normality check\n\n\n::: {.cell}\n\n```{.r .cell-code}\nperformance::check_normality(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nOK: residuals appear as normally distributed (p = 0.619).\n```\n:::\n\n```{.r .cell-code}\nperformance::check_normality(fit) %>% plot()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nหลายคนอยากดู outlier\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncheck_outliers(fit) %>% plot()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n### ขนาดเอฟเฟกต์\n\nอยากจะชวนให้ ดู effect ต่อ สำคัญอย่างไร - *p*-value บอกแค่ว่า “มีหลักฐานต่างกันไหม” ซึ่งไวต่อ ขนาดตัวอย่าง มาก แต่ ไม่บอกว่าผลที่ได้นั้นต่างกันมากขนาดไหน - ขนาดเอฟเฟกต์บอก “ผลที่ได้ใหญ่พอจะมีความหมายเชิงปฏิบัติไหม” และทำให้ เปรียบเทียบงาน/การทดลองต่างกันได้ บนมาตรฐานเดียว\n\n\n::: {.cell}\n\n```{.r .cell-code}\neffectsize::eta_squared(fit)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|Parameter |      Eta2|   CI|    CI_low| CI_high|\n|:---------|---------:|----:|---------:|-------:|\n|variety   | 0.7784061| 0.95| 0.5957645|       1|\n\n</div>\n:::\n\n```{.r .cell-code}\neffectsize::omega_squared(fit)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|Parameter |    Omega2|   CI|    CI_low| CI_high|\n|:---------|---------:|----:|---------:|-------:|\n|variety   | 0.7370013| 0.95| 0.5243762|       1|\n\n</div>\n:::\n:::\n\n\nค่า omega square (variance explained): “ทรีตเมนต์อธิบายความแปรปรวนได้ ~73% (ω²=0.73) ผลต่างเห็นได้ชัด (รู้สึกมั่นใจว่าผลการทดลองที่ได้สังเกตเห็นผลต่างได้ชัดเจน)”\n\n## post-hoc test\nแม้ปัจจุบัน นักสถิติหลายคน ไม่ค่อย สนับสนุนให้ ทำ CLD(compact letter dusplay) เพราะว่า ... แล้ว แต่ในสาขาเกษตรหรือชีววิทยา ก็ยังคงนิยมเพระาว่า ง่ายในการอธิบายผล ดังนั้น เราจะยังใช้\n\n### ประมาณค่าเฉลี่ยเปรียบเทียบ โดยการใช้ตัวอักษร\n\n\n::: {.cell}\n\n```{.r .cell-code}\nemm <- emmeans(fit, ~variety)\ncontrast(emm, \"pairwise\", adjust = \"tukey\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n contrast estimate   SE df t.ratio p.value\n v1 - v2   -16.913 2.48 20  -6.833  <.0001\n v1 - v3     0.998 2.48 20   0.403  0.9772\n v1 - v4    -9.407 2.48 20  -3.800  0.0057\n v2 - v3    17.912 2.48 20   7.236  <.0001\n v2 - v4     7.507 2.48 20   3.033  0.0307\n v3 - v4   -10.405 2.48 20  -4.203  0.0023\n\nP value adjustment: tukey method for comparing a family of 4 estimates \n```\n:::\n:::\n\n\nตารางข้างบ้นนี้ เปรียบเทียบทีละคู่ ๆ\n\n### เปรียบเทียบโดยการใช้ตัวอักษร CLD\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmean_comparisons <- fit %>%\n  emmeans(specs = \"variety\") %>%\n  cld(adjust = \"tukey\", Letters = letters)\n\nmean_comparisons\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|   |variety |   emmean|       SE| df| lower.CL| upper.CL|.group |\n|:--|:-------|--------:|--------:|--:|--------:|--------:|:------|\n|3  |v3      | 19.49167| 1.750365| 20| 14.70324| 24.28009|a      |\n|1  |v1      | 20.49000| 1.750365| 20| 15.70158| 25.27842|a      |\n|4  |v4      | 29.89667| 1.750365| 20| 25.10824| 34.68509|b      |\n|2  |v2      | 37.40333| 1.750365| 20| 32.61491| 42.19176|c      |\n\n</div>\n:::\n:::\n\n\n### กราฟเปรียบเทียบตัวแปร\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(mean_comparisons, aes(variety, emmean)) +\n  ggdist::geom_pointinterval(\n    aes(ymin = lower.CL, ymax = upper.CL)\n  ) +\n  labs(\n    x = \"Treatment\",\n    y = \"Estimated mean (95% CI)\",\n    title = \"CRD: EMMs + 95% CI\"\n  ) +\n  theme_minimal(base_size = 13)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_caption <- \"Black dots = raw data (jittered). Red dots/bars = adjusted means with 95% CIs per variety. Letters share = not different (Tukey).\"\n\nggplot() +\n  aes(x = variety) +\n\n  # จุดดิบ: jitter ป้องกันทับกัน + alpha ให้โปร่ง\n  geom_point(\n    data = dat,\n    aes(y = yield),\n    position = position_jitter(width = 0.08, height = 0),\n    alpha = 0.6,\n    size = 1.9\n  ) +\n\n  # ค่ากลางและช่วงเชื่อมั่น (ใช้ pointrange แทน point + errorbar แยก)\n  geom_pointrange(\n    data = mean_comparisons,\n    aes(y = emmean, ymin = lower.CL, ymax = upper.CL),\n    color = \"red\",\n    fatten = 1.1,\n    size = 0.6,\n    position = position_nudge(x = 0.12)\n  ) +\n\n  # ตัวอักษร CLD: ขยับไปขวาอีกหน่อย และยกขึ้นเล็กน้อย\n  geom_text(\n    data = mean_comparisons,\n    aes(y = emmean, label = .group),\n    color = \"red\",\n    position = position_nudge(x = 0.24),\n    hjust = 0,\n    vjust = -0.3,\n    fontface = \"bold\",\n    size = 3.6\n  ) +\n\n  # แกนและสเกล\n  scale_x_discrete(name = \"Variety\", expand = expansion(mult = c(0.02, 0.22))) +\n  scale_y_continuous(\n    name = \"Yield\",\n    limits = c(0, NA),\n    expand = expansion(mult = c(0, 0.08))\n  ) +\n\n  # ธีมสะอาด + ระยะขอบเผื่อข้อความ\n  theme_classic(base_size = 12) +\n  theme(\n    plot.margin = margin(t = 8, r = 24, b = 8, l = 8),\n    axis.text.x = element_text(angle = 0, vjust = 1, hjust = 0.5),\n    plot.caption = ggtext::element_textbox_simple(margin = margin(t = 6)),\n    plot.caption.position = \"plot\"\n  ) +\n  labs(caption = my_caption) +\n  coord_cartesian(clip = \"off\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n## วิธีรายงานผล\n-   รายงาน ความต่างเฉลี่ยที่สนใจ พร้อมค่า 95% CI และวิธี post-hoc test (เช่น Tukey)\n-   ใส่ขนาดเอฟเฟกต์ (เช่น partial η² หรือ ω²) เพื่อสื่อสาร\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}