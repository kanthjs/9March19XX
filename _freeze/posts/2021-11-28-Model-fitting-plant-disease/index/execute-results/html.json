{
  "hash": "c6f3be3a0c828e6f6717ce29a8c6e6d4",
  "result": {
    "markdown": "---\ntitle: \"Model fitting for Plant Disease\"\nauthor: \"Sith Jaisong\"\ndate: '2021-11-28'\ncategories: [R, PDE]\ndraft: TRUE\n---\n\n# เกริ่น\nได้เล่าไปหลาย function แล้วของ package epifitter ตังแต่ AUDPC() เพื่อวัดพื้นที่ใจ้กราฟการเพิ่มขึ้นของการระบาดเมื่อเวลาผ่านไป และ sim_() เพื่อไว้จำลองโมเดลต่าง ๆ เพื่อ ศึกษารูปแบบการเพิ่มขึ้นขึ้นของโรค\nแต่การศึกษาด้านนี้ ยังไม่จบ เพราะว่า การที่เรามี ข้อมูลจริงแล้ว ขั้นต่อไป เรามาดูว่า ข้อมูลการระบาดที่ประเมินได้ มีรูปแบบใด หรือว่า มีแบบจำลองการระบาดออกมาเป็ฯโมเดลไหนกัน จึงทำ Model fitting\n\n![](https://media.springernature.com/full/springer-static/image/art%3A10.1186%2Fs42483-021-00098-7/MediaObjects/42483_2021_98_Fig1_HTML.png?as=webp)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.0     ✔ readr     2.1.4\n✔ forcats   1.0.0     ✔ stringr   1.5.0\n✔ ggplot2   3.4.1     ✔ tibble    3.1.8\n✔ lubridate 1.9.2     ✔ tidyr     1.3.0\n✔ purrr     1.0.1     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the \u001b]8;;http://conflicted.r-lib.org/\u0007conflicted package\u001b]8;;\u0007 to force all conflicts to become errors\n```\n:::\n\n```{.r .cell-code}\nlibrary(knitr)\nlibrary(patchwork)\nlibrary(ggthemes)\nlibrary(rmarkdown)\nlibrary(cowplot)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'cowplot'\n\nThe following object is masked from 'package:ggthemes':\n\n    theme_map\n\nThe following object is masked from 'package:patchwork':\n\n    align_plots\n\nThe following object is masked from 'package:lubridate':\n\n    stamp\n```\n:::\n\n```{.r .cell-code}\ntheme_set(theme_few())\nknitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)\noptions(digits = 3)\n```\n:::\n\n# Model fitting\n\n## Data\nเปรียบเทียบการระบาดของโรคไวรัสในพริก การประเมินการเกิดโรค disease incidence ในช่วงเวลา 7 วันจนถึง 49 วัน ข้อมูลมีอยู่ในบทที่ 4 (หน้า 93)  ของหนังสือชื่อ [The studies of plant disease epidemics](https://apsjournals.apsnet.org/doi/10.1094/9780890545058.004) ป้อนข้อมูลเองและสร้างเป็น dataframe คอลัมน์แรกเป็นเวลาประเมิน และคอลัมน์อื่นๆ การจัดการโรคด้วยวิธีต่าง ๆ\n\n\n::: {.cell}\n\n```{.r .cell-code}\npepper <-\n  tibble::tribble(\n    ~time, ~trt1, ~trt2, ~trt3,\n    0, 0.08, 0.001, 0.001,\n    7, 0.13, 0.01, 0.001,\n    14, 0.78, 0.09, 0.01,\n    21, 0.92, 0.25, 0.05,\n    28, 0.99, 0.8, 0.18,\n    35, 0.995, 0.98, 0.34,\n    42, 0.999, 0.99, 0.48,\n    49, 0.999, 0.999, 0.74\n  )\npaged_table(pepper)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"time\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"trt1\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"trt2\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"trt3\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"0\",\"2\":\"0.080\",\"3\":\"0.001\",\"4\":\"0.001\"},{\"1\":\"7\",\"2\":\"0.130\",\"3\":\"0.010\",\"4\":\"0.001\"},{\"1\":\"14\",\"2\":\"0.780\",\"3\":\"0.090\",\"4\":\"0.010\"},{\"1\":\"21\",\"2\":\"0.920\",\"3\":\"0.250\",\"4\":\"0.050\"},{\"1\":\"28\",\"2\":\"0.990\",\"3\":\"0.800\",\"4\":\"0.180\"},{\"1\":\"35\",\"2\":\"0.995\",\"3\":\"0.980\",\"4\":\"0.340\"},{\"1\":\"42\",\"2\":\"0.999\",\"3\":\"0.990\",\"4\":\"0.480\"},{\"1\":\"49\",\"2\":\"0.999\",\"3\":\"0.999\",\"4\":\"0.740\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n## กราฟ\n\nเพราะว่าข้อมูลยังต้องมีการจัดโครงส้รางใหม่ ก่อน สร้างกราฟ ggplot\n\n\n::: {.cell}\n\n```{.r .cell-code}\npepper %>%\n  pivot_longer(2:4, names_to = \"treat\", values_to = \"inc\") %>%\n  ggplot(aes(time, inc,\n              linetype = treat,\n              shape = treat,\n              group = treat))+\n  geom_point(size =2)+\n  geom_line()+\n  annotate(geom = \"text\", x = 15, y = 0.84, label = \"1\")+\n  annotate(geom = \"text\", x = 23, y = 0.6, label = \"2\")+\n  annotate(geom = \"text\", x = 32, y = 0.33, label = \"3\")+\n  labs(y = \"Disease incidence (y)\",\n       x = \"Time (days)\")+\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nส่วนใหญ่แล้ว กราฟ ออกเป็นเส้นโค้ง logistic (sigmoid curve) ยกเว้น 3 ที่ ดูคล้าย exponential ซึ่งยังไม่ถึงจุดสูงสุด อาจจะประมาณว่าการระบาดยังไม่สมบูรณ์ ตรงนี้ิ สามารถดัด logistic and Gompertz Model ไปได้ เพื่อที่จะสามารถดักสินใจว่า แบบจำลองแบบไหนเหมาะกับชุดข้อมูลนนี้ เราจึงต้องทำ model fitting และประเมินทางสถิติต่อไป\n\n## Model fitting\n\nในบรรดาfunction ต่าง ๆ ที่มีให้เลือกใน  epifitter จะเริ่มต้นด้วย ตัวเลือกที่ง่ายที่สุด ซึ่งพอดีกับแบบจำลองของโรคระบาด หนึ่ง ๆ โดยใช้วิธีการถดถอยเชิงเส้น สำหรับสิ่งนี้ fit_lin() ซึ่ง ต้องการ: เวลา (t) และความรุนแรงของโรคหรือการเกิดโรค (y)\n\nเนื่องจากเรามีข้อมูลการโรคระบาดของ 3 การจัดการ จึงต้อง run fit_lin() สามครั้ง ผลจากการประเมินแบบจำลอง มาดูที่ Stats  ของแต่ละ epi1 ถึง epi3\n\n### trt1 model fitting\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(epifitter)\n\nepi1 <- fit_lin(time = pepper$time,  \n  y = pepper$trt1 )\nepi1$Stats\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                CCC r_squared   RSE\nGompertz      0.985     0.970 0.591\nMonomolecular 0.984     0.968 0.543\nLogistic      0.978     0.957 0.824\nExponential   0.784     0.645 0.670\n```\n:::\n:::\n\n\n### trt2 model fitting\n\n::: {.cell}\n\n```{.r .cell-code}\nepi2 <- fit_lin(time = pepper$time,  \n  y = pepper$trt2 )\nepi2$Stats\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                CCC r_squared   RSE\nLogistic      0.996     0.992 0.452\nGompertz      0.971     0.943 0.841\nMonomolecular 0.925     0.860 1.068\nExponential   0.897     0.813 1.202\n```\n:::\n:::\n\n\n### trt3 model fitting\n\n::: {.cell}\n\n```{.r .cell-code}\nepi3 <- fit_lin(time = pepper$time,  \n  y = pepper$trt3 )\nepi3$Stats\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                CCC r_squared   RSE\nLogistic      0.983     0.967 0.605\nGompertz      0.983     0.966 0.226\nExponential   0.964     0.930 0.771\nMonomolecular 0.859     0.753 0.253\n```\n:::\n:::\n\nจากตรงนี้ จะพบว่าที่เราเดาไว้แรก ๆ นั้น ใกล้เคียง ว่า น่าจะเป็น logistic หรือ Gompertz ซึ่ง ก็ไม่ค่อยแตกต่างกันเ้ท่าไหร่นัก แต่กการที่จะตัดสินใจว่าแบบจำลองไหนดี ควรดูกราฟกับค่าที่สังเกตได้ กับ ค่าที่พยากรณ์ได้\n\n### Multiple model fitting\n\nจะใช้ fit_multi() ซึ่ง จะต้องทำเป็น long format dataframe ก่อน ดังนั้น จะต้องเรียงข้อมูลใหม่จากเดิม\n\n\n::: {.cell}\n\n```{.r .cell-code}\npepper2 <- pepper %>%\n  pivot_longer(2:4, names_to =\"treat\", values_to = \"inc\")\npepper2\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 24 × 3\n    time treat   inc\n   <dbl> <chr> <dbl>\n 1     0 trt1  0.08 \n 2     0 trt2  0.001\n 3     0 trt3  0.001\n 4     7 trt1  0.13 \n 5     7 trt2  0.01 \n 6     7 trt3  0.001\n 7    14 trt1  0.78 \n 8    14 trt2  0.09 \n 9    14 trt3  0.01 \n10    21 trt1  0.92 \n# … with 14 more rows\n```\n:::\n:::\n\nfit_multi() ระบะ time_col คอลัมน์ไหนคือเวลา intensity_colคอลัมน์ไหนคือค่าประเมินโรค และ strata_cols คือ คอลัมน์ไหนเป็น treatment\n\n\n::: {.cell}\n\n```{.r .cell-code}\nepi_all <- fit_multi(\n  data = pepper2,\n  time_col = \"time\",\n  intensity_col = \"inc\",\n  strata_cols = \"treat\",\n  nlin = FALSE\n)\n```\n:::\n\n epifitter  จะจัดอันดับแบบจำลองตาม CCC (ยิ่งสูงยิ่งดี) แต่สิ่งสำคัญคือต้องตรวจสอบ RSE ด้วย ยิ่งต่ำยิ่งดี ในความเป็นจริง RSE มีความสำคัญมากกว่าเมื่อจุดประสงค์ของเราคือการทำนาย\n\n#### statistical check\n\n::: {.cell}\n\n```{.r .cell-code}\nepi_all$Parameters %>%\n  select(treat, model, best_model, RSE, CCC)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   treat         model best_model   RSE   CCC\n1   trt1      Gompertz          1 0.591 0.985\n2   trt1 Monomolecular          2 0.543 0.984\n3   trt1      Logistic          3 0.824 0.978\n4   trt1   Exponential          4 0.671 0.784\n5   trt2      Logistic          1 0.452 0.996\n6   trt2      Gompertz          2 0.841 0.971\n7   trt2 Monomolecular          3 1.068 0.925\n8   trt2   Exponential          4 1.202 0.897\n9   trt3      Logistic          1 0.605 0.983\n10  trt3      Gompertz          2 0.226 0.982\n11  trt3   Exponential          3 0.771 0.964\n12  trt3 Monomolecular          4 0.253 0.859\n```\n:::\n:::\n\nเราจะเลือก แบบจำลอง logistic และ Gompertz มาเปรียบเทียบกันดู\n\n\n::: {.cell}\n\n```{.r .cell-code}\nepi_all$Data %>% head() %>% paged_table()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"treat\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"time\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"y\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"model\"],\"name\":[4],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"linearized\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"predicted\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"residual\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"trt1\",\"2\":\"0\",\"3\":\"0.08\",\"4\":\"Exponential\",\"5\":\"-2.5257\",\"6\":\"0.1638\",\"7\":\"-0.0838\",\"_rn_\":\"1\"},{\"1\":\"trt1\",\"2\":\"0\",\"3\":\"0.08\",\"4\":\"Monomolecular\",\"5\":\"0.0834\",\"6\":\"-0.5881\",\"7\":\"0.6681\",\"_rn_\":\"2\"},{\"1\":\"trt1\",\"2\":\"0\",\"3\":\"0.08\",\"4\":\"Logistic\",\"5\":\"-2.4423\",\"6\":\"0.0935\",\"7\":\"-0.0135\",\"_rn_\":\"3\"},{\"1\":\"trt1\",\"2\":\"0\",\"3\":\"0.08\",\"4\":\"Gompertz\",\"5\":\"-0.9265\",\"6\":\"0.0355\",\"7\":\"0.0445\",\"_rn_\":\"4\"},{\"1\":\"trt1\",\"2\":\"7\",\"3\":\"0.13\",\"4\":\"Exponential\",\"5\":\"-2.0402\",\"6\":\"0.2305\",\"7\":\"-0.1005\",\"_rn_\":\"5\"},{\"1\":\"trt1\",\"2\":\"7\",\"3\":\"0.13\",\"4\":\"Monomolecular\",\"5\":\"0.1393\",\"6\":\"0.4878\",\"7\":\"-0.3578\",\"_rn_\":\"6\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\nจาก Data ของทำ model fitting นั้น จะมีค่าต่าง ๆ เพื่อให้มันใจต่อไปว่า ระหว่าง logistic หรือ Gompertz จะต้อง มาพล้อตกราฟว่า กราฟที่พยากรณ์ได้จากmodel กับค่าจริง มีความใกล้เคียงกันแค่ไหน\n\n#### graph check\n\n\n::: {.cell}\n\n```{.r .cell-code}\nepi_all$Data %>%\n filter(model %in% c(\"Gompertz\", \"Logistic\")) %>%\n  ggplot(aes(time, predicted, shape = treat)) +\n  geom_point(aes(time, y)) +\n  geom_line() +\n  facet_wrap(~ model) +\n coord_cartesian(ylim = c(0, 1)) + # set the max to 0.6\n  labs(\n    y = \"Disease incidence\",\n    x = \"Time (days after emergence)\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\n#### error check\n\nต่อมาดูความคลาดเคลื่อนกันบ้างว่า model ที่เกิดควาดเคลื่อน ตลอดช่ในช่วงเวลา\n\n\n::: {.cell}\n\n```{.r .cell-code}\nepi_all$Data %>%\n filter(model %in% c(\"Gompertz\", \"Logistic\")) %>%\n  ggplot(aes(time, predicted -y, shape = treat)) +\n  geom_point() +\n  geom_line() +\n  geom_hline(yintercept = 0, linetype =2)+\n  facet_wrap(~ model) +\n coord_cartesian(ylim = c(-0.4, 0.4)) + # set the max to 0.6\n  labs(\n    y = \"Prediction error\",\n    x = \"Time (days after emergence)\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\nจะเห็นว่า logistic มีความคลาดเคลื่อนน้อยกว่า Gompertz\n\nเจาะลึกลงดูว่า treatment ไหนกันที่มีประสิทธิช่วยลดการระบาดของโรคได้ดี ซึ่งโดยทั่วไป เราจะวัดกันที่ค่า *r* (dy/dt) ถ้าค่า r น้อยกว่านั้นแสดงให้เห็นว่าโรคมีการพัฒนาช้ากว่า\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nepi_all$Parameters %>%\n  filter(model == \"Logistic\") %>%\n  select(treat, y0, y0_ci_lwr, y0_ci_upr, r, r_ci_lwr, r_ci_upr\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  treat       y0 y0_ci_lwr y0_ci_upr     r r_ci_lwr r_ci_upr\n1  trt1 0.093504  0.027321   0.27473 0.210    0.166    0.255\n2  trt2 0.001373  0.000672   0.00280 0.278    0.254    0.303\n3  trt3 0.000813  0.000313   0.00211 0.175    0.143    0.208\n```\n:::\n:::\n\n\nสามารถ พล้อต ค่าเฉลี่ยของอัตราการเกิดโรค และ ที่ระดับ 95% confidence interval\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- epi_all$Parameters %>%\n  filter(model == \"Logistic\") %>%\n  ggplot(aes(treat, r)) +\n  geom_point(size = 3) +\n  geom_errorbar(aes(ymin = r_ci_lwr, ymax = r_ci_upr),\n    width = 0,\n    size = 1\n  ) +\n  labs(\n    x = \"Time\",\n    y = \"r\"\n  )\np2 <- epi_all$Parameters %>%\n  filter(model == \"Logistic\") %>%\n  ggplot(aes(treat, 1 - exp(-y0))) +\n  geom_point(size = 3) +\n  geom_errorbar(aes(ymin = y0_ci_lwr, ymax = y0_ci_upr),\n    width = 0,\n    size = 1\n  ) +\n  labs(\n    x = \"Time\",\n    y = \"y0\"\n  )\n\np1 | p2\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\nจากตรงนี้ เราก็จะทราบว่าโมเดลอะไรที่เหมาะสมกับข้อมูลของเรา และ ค่า Parametersที่นำไปประกอบ model เช่น r และ y0\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}